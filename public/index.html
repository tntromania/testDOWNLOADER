<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Downloader</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 999;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-download-btn.loading {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .modal-download-btn.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        /* Modal Box */
        .download-modal {
            background: rgba(15, 20, 30, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 500px;
            width: 90%;
            box-shadow:
                    0 20px 60px rgba(0, 0, 0, 0.8),
                    inset 0 0 0 1px rgba(255,255,255,0.04);
            animation: slideUp 0.4s ease;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: rotate(90deg);
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #FFE076 0%, #FFB400 60%, #FF9500 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(255, 180, 0, 0.3);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: #fff;
            text-align: center;
            line-height: 1.3;
        }

        .modal-subtitle {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 28px;
            text-align: center;
        }

        .modal-subtitle strong {
            color: #FFB400;
            font-weight: 700;
        }

        .modal-download-btn {
            width: 100%;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: #fff;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
        }

        .modal-download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(46, 204, 113, 0.45);
            filter: brightness(1.1);
        }

        .modal-info {
            margin-top: 20px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            line-height: 1.6;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">SmartCreator</div>
        <p class="subtitle">YouTube Downloader Pro</p>
    </header>

    <div class="input-card">
        <input type="url" id="urlInput" placeholder="Lipe»ôte link-ul YouTube aici..." autocomplete="off">
        <button class="btn-go" id="processBtn">ProceseazƒÉ</button>
    </div>

    <div class="loader-container" id="loaderContainer">
        <div class="loader"></div>
        <div class="loader-text" id="loaderText">Se √ÆncarcƒÉ...</div>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <div id="resultContainer" class="result-container">
        <div class="video-card">

            <div class="media-preview">
                <img id="thumbImg" src="" alt="">
                <span class="duration-badge" id="durationBadge">00:00</span>
            </div>

            <div class="card-body">
                <h3 id="videoTitle">Titlu Video</h3>

                <div class="quality-label">Alege Calitatea:</div>
                <div class="quality-grid" id="qualityGrid"></div>

                <button id="downloadBtn" class="dl-btn">
                    üì• DescarcƒÉ Videoclipul
                </button>

                <div class="transcript" id="transcriptBox" style="display:none">
                    <div class="transcript-head" onclick="toggleTranscript()">
                        <span>üìù Transcript (SubtitrƒÉri)</span>
                        <div>
                            <span style="font-size: 0.8rem; color: #FFB400; cursor: pointer; margin-right: 10px;" id="translateBtn">Traduce √Æn Rom√¢nƒÉ</span>
                            <span style="font-size: 0.8rem; color: #FFB400; cursor: pointer;" id="copyBtn">CopiazƒÉ</span>
                        </div>
                    </div>
                    <div class="transcript-body" id="transcriptText"></div>
                </div>

            </div>
        </div>
    </div>

</div>

<!-- Modal Download -->
<div class="modal-overlay" id="modalOverlay">
    <div class="download-modal">
        <button class="modal-close" onclick="closeModal()">‚úï</button>

        <div class="modal-icon">üì•</div>

        <h2 class="modal-title" id="modalTitle">PregƒÉtire descƒÉrcare...</h2>
        <p class="modal-subtitle">
            Calitate selectatƒÉ: <strong id="modalQuality">720p</strong>
        </p>

        <a class="modal-download-btn" id="modalDownloadBtn" href="#" target="_blank">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            DescarcƒÉ Acum
        </a>

        <p class="modal-info">
            Se va deschide o fereastrƒÉ nouƒÉ cu descƒÉrcarea.<br>
            DacƒÉ descƒÉrcarea nu porne»ôte, click din nou pe buton.
        </p>
    </div>
</div>

<script>
    const API_URL = 'https://app-download-whn1.onrender.com';

    const urlInput = document.getElementById('urlInput');
    const processBtn = document.getElementById('processBtn');
    const loaderContainer = document.getElementById('loaderContainer');
    const loaderText = document.getElementById('loaderText');
    const errorMsg = document.getElementById('errorMsg');
    const resultContainer = document.getElementById('resultContainer');

    const thumbImg = document.getElementById('thumbImg');
    const durationBadge = document.getElementById('durationBadge');
    const videoTitle = document.getElementById('videoTitle');
    const qualityGrid = document.getElementById('qualityGrid');
    const downloadBtn = document.getElementById('downloadBtn');
    const transcriptBox = document.getElementById('transcriptBox');
    const transcriptText = document.getElementById('transcriptText');
    const copyBtn = document.getElementById('copyBtn');
    const translateBtn = document.getElementById('translateBtn');

    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalQuality = document.getElementById('modalQuality');
    const modalDownloadBtn = document.getElementById('modalDownloadBtn');

    let currentFormats = [];
    let selectedFormat = null;
    let currentVideoUrl = '';
    let currentTitle = '';
    let originalTranscript = '';
    let isTranslated = false;
    let processingTimeout = null;

    function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 5000);
    }

    // Func»õie pentru a extrage »ôi filtra calitƒÉ»õile video (144p - 1080p)
    function filterVideoFormats(formats) {
        const qualityOrder = {
            '144p': 1,
            '240p': 2,
            '360p': 3,
            '480p': 4,
            '720p': 5,
            '1080p': 6
        };

        // FiltreazƒÉ doar formatele video (nu audio-only)
        const videoFormats = formats.filter(format => {
            const quality = format.qualityLabel || format.quality || '';
            const hasVideo = format.hasVideo !== false && format.mimeType && format.mimeType.includes('video');
            return hasVideo && quality.match(/\d+p/i);
        });

        // SorteazƒÉ dupƒÉ calitate
        videoFormats.sort((a, b) => {
            const qualityA = (a.qualityLabel || a.quality || '').match(/(\d+)p/i);
            const qualityB = (b.qualityLabel || b.quality || '').match(/(\d+)p/i);

            if (!qualityA || !qualityB) return 0;

            const numA = parseInt(qualityA[1]);
            const numB = parseInt(qualityB[1]);

            return numA - numB; // Sortare crescƒÉtoare: 144p, 240p, 360p, etc.
        });

        // EliminƒÉ duplicatele »ôi pƒÉstreazƒÉ doar calitƒÉ»õile de la 144p la 1080p
        const uniqueFormats = [];
        const seenQualities = new Set();

        videoFormats.forEach(format => {
            const quality = (format.qualityLabel || format.quality || '').match(/(\d+)p/i);
            if (quality) {
                const qualityNum = parseInt(quality[1]);
                if (qualityNum >= 144 && qualityNum <= 1080) {
                    const qualityKey = quality[0].toLowerCase();
                    if (!seenQualities.has(qualityKey)) {
                        seenQualities.add(qualityKey);
                        uniqueFormats.push(format);
                    }
                }
            }
        });

        return uniqueFormats;
    }


    async function processVideo() {
        const url = urlInput.value.trim();
        if (!url) {
            showError('Te rog introdu un link valid!');
            return;
        }

        // ValideazƒÉ cƒÉ este un link YouTube
        if (!isValidYouTubeUrl(url)) {
            showError('Te rog introdu un link YouTube valid! (ex: youtube.com/watch?v=...)');
            return;
        }

        resultContainer.style.display = 'none';
        errorMsg.style.display = 'none';
        loaderContainer.style.display = 'block';
        loaderText.textContent = 'Se √ÆncarcƒÉ detaliile video...';
        processBtn.disabled = true;
        processBtn.innerText = 'Se √ÆncarcƒÉ...';

        const startTime = Date.now();

        try {
            // Folose»ôte noul endpoint /api/download
            const res = await fetch(`${API_URL}/api/download?url=${encodeURIComponent(url)}&platform=youtube`);

            // VerificƒÉ dacƒÉ rƒÉspunsul este OK
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.error || `Server error: ${res.status} ${res.statusText}`);
            }

            const data = await res.json();
            const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);
            console.log(`‚ö° √éncƒÉrcat √Æn ${loadTime}s`);
            console.log('üì¶ Data primitƒÉ:', data);

            if (data.status !== 'ok') {
                throw new Error(data.error || 'Eroare necunoscutƒÉ');
            }

            // ActualizeazƒÉ informa»õiile video
            videoTitle.textContent = data.data.title || 'Video fƒÉrƒÉ titlu';
            currentTitle = data.data.title || 'Video';
            currentVideoUrl = url;

            // SimuleazƒÉ formatele pentru calitƒÉ»õi (pentru compatibilitate)
            const formats = data.data.formats || [];
            currentFormats = formats.map(f => ({
                qualityLabel: f.quality,
                quality: f.quality,
                format: f.format,
                url: f.url
            }));

            console.log('‚úÖ Formate disponibile:', currentFormats.length);

            qualityGrid.innerHTML = '';

            if (currentFormats.length > 0) {
                currentFormats.forEach((format, index) => {
                    const btn = document.createElement('div');
                    btn.className = `q-btn ${index === 0 ? 'active' : ''}`;
                    const qualityLabel = format.qualityLabel || format.quality || 'N/A';
                    btn.innerHTML = `
            <span class="q-res">${qualityLabel}</span>
            <span class="q-size">${format.format.toUpperCase()}</span>
          `;

                    btn.onclick = () => selectQuality(index, btn);
                    qualityGrid.appendChild(btn);
                });

                selectedFormat = currentFormats[0];
            } else {
                showError('Nu s-au gƒÉsit formate disponibile.');
            }

            // Gestionare transcript
            loaderText.textContent = 'Se ob»õine transcript-ul...';
            const transcriptData = data.data.transcript;

            if (transcriptData && transcriptData.original) {
                console.log('‚úÖ Transcript gƒÉsit!');
                originalTranscript = transcriptData.original;
                transcriptText.textContent = transcriptData.translated || transcriptData.original;
                transcriptBox.style.display = 'block';
                isTranslated = transcriptData.translated ? true : false;
                translateBtn.textContent = transcriptData.translated ? 'Original' : 'Traduce √Æn Rom√¢nƒÉ';

                // DacƒÉ avem deja traducerea, o afi»ôƒÉm direct
                if (transcriptData.translated) {
                    console.log('‚úÖ Traducere deja disponibilƒÉ!');
                }
            } else {
                console.log('‚ö†Ô∏è Nu s-a gƒÉsit transcript');
                transcriptBox.style.display = 'none';
            }

            loaderContainer.style.display = 'none';
            resultContainer.style.display = 'block';

        } catch (err) {
            console.error('Eroare:', err);

            // Mesaje de eroare mai clare
            let errorMessage = 'A apƒÉrut o eroare. √éncearcƒÉ din nou.';

            if (err.message.includes('404')) {
                errorMessage = 'Serverul nu este disponibil. VerificƒÉ conexiunea la internet.';
            } else if (err.message.includes('Failed to fetch')) {
                errorMessage = 'Nu s-a putut conecta la server. VerificƒÉ conexiunea la internet.';
            } else if (err.message.includes('Server error')) {
                errorMessage = `Eroare server: ${err.message}`;
            } else if (err.message) {
                errorMessage = err.message;
            }

            showError(errorMessage);
            loaderContainer.style.display = 'none';
        } finally {
            processBtn.disabled = false;
            processBtn.innerText = 'ProceseazƒÉ';
        }
    }

    function selectQuality(index, btnElement) {
        document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        selectedFormat = currentFormats[index];
    }

    async function downloadVideo() {
        if (!selectedFormat) {
            showError('SelecteazƒÉ o calitate!');
            return;
        }

        // Deschide modalul
        modalTitle.textContent = currentTitle;
        const qualityLabel = selectedFormat.qualityLabel || selectedFormat.quality || '720p';
        modalQuality.textContent = qualityLabel;

        // Folose»ôte URL-ul direct din format
        const downloadUrl = selectedFormat.url || `${API_URL}/api/stream?url=${encodeURIComponent(currentVideoUrl)}&type=${selectedFormat.format === 'mp3' ? 'audio' : 'video'}`;

        // Afi»ôeazƒÉ mesaj de √ÆncƒÉrcare √Æn modal
        modalDownloadBtn.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Se pregƒÉte»ôte link-ul...';
        modalDownloadBtn.style.opacity = '0.7';
        modalDownloadBtn.style.pointerEvents = 'none';
        modalDownloadBtn.classList.add('loading');

        modalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        try {
            // SeteazƒÉ link-ul direct √Æn buton
            modalDownloadBtn.href = downloadUrl;
            modalDownloadBtn.download = `${currentTitle}.${selectedFormat.format}`;
            modalDownloadBtn.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> DescarcƒÉ Acum';
            modalDownloadBtn.style.opacity = '1';
            modalDownloadBtn.style.pointerEvents = 'auto';
            modalDownloadBtn.classList.remove('loading');

            // Deschide automat link-ul dupƒÉ scurt delay
            setTimeout(() => {
                modalDownloadBtn.click();
            }, 800);

        } catch (error) {
            console.error('Eroare la descƒÉrcare:', error);

            // Afi»ôeazƒÉ eroare √Æn modal
            modalTitle.textContent = 'Eroare la descƒÉrcare';
            modalDownloadBtn.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> √éncearcƒÉ din nou';
            modalDownloadBtn.style.opacity = '1';
            modalDownloadBtn.style.pointerEvents = 'auto';
            modalDownloadBtn.classList.remove('loading');
            modalDownloadBtn.classList.add('error');

            // Pentru fallback, deschide pagina video
            modalDownloadBtn.onclick = function(e) {
                e.preventDefault();
                window.open(currentVideoUrl, '_blank');
                closeModal();
            };

            // AratƒÉ »ôi mesaj de eroare
            setTimeout(() => {
                showError(`Eroare: ${error.message}. √éncearcƒÉ din nou.`);
            }, 300);
        }
    }

    function closeModal() {
        modalOverlay.classList.remove('active');
        document.body.style.overflow = 'auto';

        // Reset buton modal
        modalDownloadBtn.innerHTML = '<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> DescarcƒÉ Acum';
        modalDownloadBtn.style.opacity = '1';
        modalDownloadBtn.style.pointerEvents = 'auto';
        modalDownloadBtn.classList.remove('loading', 'error');
    }

    function toggleTranscript() {
        const body = transcriptText;
        if (body.style.display === 'none' || !body.style.display) {
            body.style.display = 'block';
        } else {
            body.style.display = 'none';
        }
    }

    function copyTranscript() {
        const text = transcriptText.textContent;
        navigator.clipboard.writeText(text).then(() => {
            const oldText = copyBtn.textContent;
            copyBtn.textContent = '‚úÖ Copiat!';
            setTimeout(() => {
                copyBtn.textContent = oldText;
            }, 2000);
        });
    }

    async function translateTranscript() {
        if (isTranslated) {
            // Revenire la original
            transcriptText.textContent = originalTranscript;
            translateBtn.textContent = 'Traduce √Æn Rom√¢nƒÉ';
            isTranslated = false;
            return;
        }

        // DacƒÉ traducerea a fost deja fƒÉcutƒÉ de server, o folosim direct
        // Altfel, o traducem acum
        const oldText = translateBtn.textContent;
        translateBtn.textContent = 'Se traduce...';
        translateBtn.style.opacity = '0.5';
        transcriptText.textContent = 'Se traduce...';

        try {
            // √éncearcƒÉ mai √Ænt√¢i prin API-ul backend pentru traducere mai bunƒÉ
            try {
                const response = await fetch(`${API_URL}/api/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: originalTranscript,
                        from: 'en',
                        to: 'ro'
                    })
                });

                const data = await response.json();
                if (data.success && data.translatedText) {
                    transcriptText.textContent = data.translatedText;
                    translateBtn.textContent = 'Original';
                    isTranslated = true;
                    translateBtn.style.opacity = '1';
                    return;
                }
            } catch (apiError) {
                console.log('API translation failed, trying alternatives...');
            }

            // Fallback 1: √éncearcƒÉ cu LibreTranslate (gratuit »ôi mai bun dec√¢t MyMemory)
            try {
                const libreResponse = await fetch('https://libretranslate.com/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        q: originalTranscript.substring(0, 5000), // LimiteazƒÉ la 5000 caractere
                        source: 'en',
                        target: 'ro',
                        format: 'text'
                    })
                });

                const libreData = await libreResponse.json();
                if (libreData.translatedText) {
                    transcriptText.textContent = libreData.translatedText;
                    translateBtn.textContent = 'Original';
                    isTranslated = true;
                    translateBtn.style.opacity = '1';
                    return;
                }
            } catch (libreError) {
                console.log('LibreTranslate failed, trying MyMemory...');
            }

            // Fallback 2: MyMemory (ultimul rezort)
            const text = encodeURIComponent(originalTranscript.substring(0, 500));
            const response = await fetch(`https://api.mymemory.translated.net/get?q=${text}&langpair=en|ro`);
            const data = await response.json();

            if (data.responseData && data.responseData.translatedText) {
                transcriptText.textContent = data.responseData.translatedText;
                translateBtn.textContent = 'Original';
                isTranslated = true;
            } else {
                throw new Error('Traducerea a e»ôuat');
            }
        } catch (error) {
            console.error('Translation error:', error);
            showError('Nu s-a putut traduce. √éncearcƒÉ din nou.');
            transcriptText.textContent = originalTranscript;
            translateBtn.textContent = oldText;
        } finally {
            translateBtn.style.opacity = '1';
        }
    }

    // Func»õie pentru validare URL YouTube
    function isValidYouTubeUrl(url) {
        if (!url || url.trim().length === 0) return false;

        const youtubePatterns = [
            /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/,
            /youtube\.com\/watch\?v=([^"&?\/\s]{11})/,
            /youtu\.be\/([^"&?\/\s]{11})/,
            /youtube\.com\/embed\/([^"&?\/\s]{11})/,
            /youtube\.com\/v\/([^"&?\/\s]{11})/
        ];

        return youtubePatterns.some(pattern => pattern.test(url));
    }

    // Func»õie pentru procesare automatƒÉ instant c√¢nd se introduce link-ul
    function handleUrlInput() {
        const url = urlInput.value.trim();

        // AnuleazƒÉ timeout-ul anterior dacƒÉ existƒÉ
        if (processingTimeout) {
            clearTimeout(processingTimeout);
        }

        // DacƒÉ link-ul este valid YouTube, proceseazƒÉ automat dupƒÉ 500ms
        if (isValidYouTubeUrl(url)) {
            processingTimeout = setTimeout(() => {
                processVideo();
            }, 500);
        }
    }

    // Event Listeners
    downloadBtn.addEventListener('click', downloadVideo);
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) closeModal();
    });
    copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        copyTranscript();
    });
    translateBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        translateTranscript();
    });
    processBtn.addEventListener('click', processVideo);

    // Procesare automatƒÉ instant c√¢nd se lipe»ôte sau se introduce link-ul
    urlInput.addEventListener('paste', () => {
        setTimeout(handleUrlInput, 100);
    });
    urlInput.addEventListener('input', handleUrlInput);
    urlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            if (processingTimeout) clearTimeout(processingTimeout);
            processVideo();
        }
    });
</script>

</body>
</html>
